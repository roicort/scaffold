---
type Props = {
  label?: string;
  class?: string;
  timeZone?: string;
  locale?: string;
  hour12?: boolean;
};

const {
  label = 'Local time',
  class: className = '',
  timeZone,
  locale = 'en-US',
  hour12 = true,
}: Props = Astro.props;
const classes = ['flex items-center gap-2', className].filter(Boolean).join(' ');
const clockId = `clock-${Math.random().toString(36).slice(2, 8)}`;
const formatter = new Intl.DateTimeFormat(locale, {
  hour: '2-digit',
  minute: '2-digit',
  hour12,
  timeZone,
});

const initialTime = formatter.format(new Date());
---

<div class={classes}>
  {label && <span class="text-xs uppercase tracking-[0.08em] text-subtle">{label}</span>}
  <span id={clockId} aria-live="polite" class="text-sm font-semibold text-ink">{initialTime}</span>
</div>

<script type="module">
  const clockId = '{clockId}';
  const locale = '{locale}';
  const timeZone = '{timeZone ?? ''}';
  const hour12 = {hour12 ? 'true' : 'false'};
  const clockEl = document.getElementById(clockId);

  const formatter = new Intl.DateTimeFormat(locale, {
    hour: '2-digit',
    minute: '2-digit',
    hour12,
    timeZone: timeZone || undefined,
  });

  function updateClock() {
    if (!clockEl) return;
    clockEl.textContent = formatter.format(new Date());
  }

  updateClock();

  const now = new Date();
  const msToNextMinute = (60 - now.getSeconds()) * 1000 - now.getMilliseconds();
  setTimeout(() => {
    updateClock();
    setInterval(updateClock, 60 * 1000);
  }, msToNextMinute);
</script>
