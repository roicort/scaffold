---
import { SITE_TITLE } from '../consts';
import HeaderLink from './HeaderLink.astro';
import Search from "astro-pagefind/components/Search";
const subpath = import.meta.env.BASE_URL;

---

<header class="fixed top-4 z-30 w-full px-4 md:px-10">
	<div class="mx-auto max-w-6xl rounded-xl border border-[color:var(--color-border)] bg-[color:var(--color-surface)] px-4 py-3 md:px-6 md:py-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
		<div class="flex items-center justify-between gap-4">
			<div class="flex flex-col">
				<h1 class="text-base font-semibold tracking-[0.18em] uppercase m-0">
					<a href={subpath} class="hover:opacity-80 transition-opacity">{SITE_TITLE}</a>
				</h1>
			</div>
		</div>
		<div class="flex flex-col gap-2 md:gap-3 md:flex-row md:items-center md:justify-end">
			<nav class="flex flex-wrap items-center gap-2 md:gap-4 text-[0.72rem] tracking-[0.24em] uppercase text-muted">
				<HeaderLink href="/blog">Blog</HeaderLink>
				<HeaderLink href="/team">Team</HeaderLink>
				<HeaderLink href="/about">About</HeaderLink>
				<button
					type="button"
					id="search-toggle"
					aria-haspopup="dialog"
					aria-controls="search-modal"
					aria-expanded="false"
					class="search-trigger"
				>
					<span class="search-trigger__icon" aria-hidden="true">
						<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
							<circle cx="11" cy="11" r="6" />
							<path d="m20 20-4-4" />
						</svg>
					</span>
					<span class="search-trigger__label">Search</span>
				</button>
				<button class="theme-toggle" type="button" id="theme-toggle" aria-label="Toggle theme">
					<span class="sr-only">Toggle theme</span>
					<span class="theme-toggle__icon theme-toggle__icon--sun" aria-hidden="true">
						<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
							<circle cx="12" cy="12" r="4" />
							<path d="M12 3v2m0 14v2m9-9h-2M5 12H3m14.95 6.95-1.414-1.414M7.464 7.464 6.05 6.05m0 11.9 1.414-1.414M18.364 5.636l-1.414 1.414" />
						</svg>
					</span>
					<span class="theme-toggle__icon theme-toggle__icon--moon" aria-hidden="true">
						<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
							<path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79Z" />
						</svg>
					</span>
				</button>
			</nav>
		</div>
	</div>
</header>

<div
	id="search-modal"
	class="search-modal"
	role="dialog"
	aria-modal="true"
	aria-hidden="true"
	aria-labelledby="search-modal-title"
>
	<div class="search-modal__backdrop" data-close="search"></div>
	<div class="search-modal__panel">
		<div class="search-modal__header">
			<div class="search-modal__title">
				<p class="search-modal__eyebrow">Search</p>
				<h2 id="search-modal-title">Find anything on the site</h2>
			</div>
			<div class="search-modal__actions">
				<span class="search-modal__hint">Esc</span>
				<button type="button" class="search-close" id="search-close" aria-label="Close search dialog">
					<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
						<path d="m15 9-6 6m0-6 6 6" />
					</svg>
				</button>
			</div>
		</div>
		<Search id="search" className="pagefind-ui" uiOptions={{ showImages: false }} />
		<p class="search-modal__footnote">Powered by Pagefind. Start typing to search posts, pages, and team members.</p>
	</div>
</div>

<script is:inline>
const STORAGE_KEY = 'theme';

const getPreferredTheme = () => {
	const stored = localStorage.getItem(STORAGE_KEY);
	if (stored === 'light' || stored === 'dark') return stored;
	return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
};

const applyTheme = (theme) => {
	document.documentElement.dataset.theme = theme;
	const button = document.getElementById('theme-toggle');
	if (button) button.setAttribute('aria-pressed', theme === 'dark' ? 'true' : 'false');
};

const initTheme = () => {
	const theme = getPreferredTheme();
	applyTheme(theme);
};

const toggleTheme = () => {
	const current = document.documentElement.dataset.theme === 'dark' ? 'dark' : 'light';
	const next = current === 'dark' ? 'light' : 'dark';
	localStorage.setItem(STORAGE_KEY, next);
	applyTheme(next);
};

initTheme();

const toggleButton = document.getElementById('theme-toggle');
if (toggleButton) {
	toggleButton.addEventListener('click', toggleTheme);
}

const searchModal = document.getElementById('search-modal');
const searchToggle = document.getElementById('search-toggle');
const searchClose = document.getElementById('search-close');
const searchBackdrop = document.querySelector('[data-close="search"]');

const setSearchVisibility = (isOpen) => {
	if (!searchModal) return;
	searchModal.classList.toggle('is-open', isOpen);
	searchModal.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
	if (searchToggle) searchToggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
	document.body.classList.toggle('search-open', isOpen);
};

const focusSearchInput = () => {
	const input = document.querySelector('#search-modal .pagefind-ui__search-input');
	if (input instanceof HTMLInputElement) {
		input.focus();
		input.select();
	}
};

const openSearch = () => {
	setSearchVisibility(true);
	window.requestAnimationFrame(() => {
		window.setTimeout(focusSearchInput, 60);
	});
};

const closeSearch = () => {
	setSearchVisibility(false);
};

if (searchToggle) searchToggle.addEventListener('click', openSearch);
if (searchClose) searchClose.addEventListener('click', closeSearch);
if (searchBackdrop) searchBackdrop.addEventListener('click', closeSearch);

window.addEventListener('keydown', (event) => {
	if (event.key === 'Escape' && searchModal?.classList.contains('is-open')) {
		closeSearch();
	}
});
</script>

<style is:inline>
.theme-toggle {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	width: 36px;
	height: 36px;
	border: 1px solid var(--color-border, rgba(0, 0, 0, 0.12));
	border-radius: 9999px;
	background: color-mix(in oklab, var(--color-surface, #fff) 92%, transparent 8%);
	color: var(--color-ink, currentColor);
	transition: border-color 150ms ease, background-color 150ms ease, color 150ms ease;
}
.theme-toggle:hover {
	border-color: color-mix(in oklab, var(--color-ink, #111) 32%, transparent);
	background: color-mix(in oklab, var(--color-surface, #fff) 85%, var(--color-ink, #111) 5%);
}
.theme-toggle__icon--moon {
	display: none;
}
html[data-theme='dark'] .theme-toggle__icon--sun {
	display: none;
}
html[data-theme='dark'] .theme-toggle__icon--moon {
	display: inline-flex;
}

.search-trigger {
	display: inline-flex;
	align-items: center;
	gap: 0.45rem;
	padding: 0.5rem 0.8rem;
	border: 1px solid var(--color-border, rgba(0, 0, 0, 0.12));
	border-radius: 999px;
	background: color-mix(in oklab, var(--color-surface, #fff) 94%, transparent);
	color: var(--color-ink, currentColor);
	font-weight: 600;
	letter-spacing: 0.12em;
	text-transform: uppercase;
	transition: border-color 150ms ease, background-color 150ms ease, transform 150ms ease;
	cursor: pointer;
}

.search-trigger:hover {
	border-color: color-mix(in oklab, var(--color-ink, #111) 28%, transparent);
	background: color-mix(in oklab, var(--color-surface, #fff) 88%, var(--color-ink, #111) 6%);
	transform: translateY(-1px);
}

.search-trigger__label {
	font-size: 0.72rem;
}

.search-trigger__icon {
	display: inline-flex;
	align-items: center;
	justify-content: center;
}

.search-modal {
	position: fixed;
	inset: 0;
	z-index: 40;
	display: flex;
	align-items: flex-start;
	justify-content: center;
	padding: clamp(12px, 4vw, 32px);
	opacity: 0;
	pointer-events: none;
	transition: opacity 180ms ease;
}

.search-modal.is-open {
	opacity: 1;
	pointer-events: auto;
}

.search-modal__backdrop {
	position: absolute;
	inset: 0;
	background: color-mix(in oklab, var(--color-paper, #f9f9f9) 35%, #06060a 65%);
	backdrop-filter: blur(14px) saturate(1.2);
	opacity: 0.94;
}

.search-modal__panel {
	position: relative;
	width: min(960px, 100%);
	margin-top: clamp(32px, 6vh, 96px);
	border: 1px solid var(--color-border, rgba(0, 0, 0, 0.12));
	background: color-mix(in oklab, var(--color-surface, #fff) 94%, transparent);
	border-radius: 24px;
	box-shadow: 0 24px 80px color-mix(in oklab, var(--color-ink, #111) 12%, transparent);
	padding: clamp(1rem, 2vw, 1.5rem);
	z-index: 1;
}

.search-modal__header {
	display: flex;
	align-items: center;
	justify-content: space-between;
	gap: 1rem;
	margin-bottom: 0.75rem;
}

.search-modal__title h2 {
	margin: 0.15rem 0 0;
	font-size: clamp(1.2rem, 2vw, 1.45rem);
}

.search-modal__eyebrow {
	margin: 0;
	font-size: 0.7rem;
	letter-spacing: 0.2em;
	text-transform: uppercase;
	color: var(--color-muted, #6b6b6b);
}

.search-modal__actions {
	display: inline-flex;
	align-items: center;
	gap: 0.65rem;
}

.search-modal__hint {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	min-width: 42px;
	padding: 0.35rem 0.5rem;
	border-radius: 10px;
	border: 1px solid var(--color-border, rgba(0, 0, 0, 0.12));
	background: color-mix(in oklab, var(--color-surface, #fff) 85%, var(--color-ink, #111) 4%);
	font-size: 0.72rem;
	letter-spacing: 0.1em;
	text-transform: uppercase;
}

.search-close {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	width: 36px;
	height: 36px;
	border-radius: 12px;
	border: 1px solid var(--color-border, rgba(0, 0, 0, 0.12));
	background: color-mix(in oklab, var(--color-surface, #fff) 90%, transparent);
	color: var(--color-ink, currentColor);
	cursor: pointer;
	transition: border-color 150ms ease, background-color 150ms ease, transform 150ms ease;
}

.search-close:hover {
	border-color: color-mix(in oklab, var(--color-ink, #111) 26%, transparent);
	background: color-mix(in oklab, var(--color-surface, #fff) 82%, var(--color-ink, #111) 6%);
	transform: translateY(-1px);
}

.search-modal__footnote {
	margin: 0.75rem 0 0;
	font-size: 0.82rem;
	color: var(--color-muted, #6b6b6b);
}

:global(body.search-open) {
	overflow: hidden;
}

:global(#search-modal .pagefind-ui) {
	width: 100%;
}

:global(#search-modal .pagefind-ui__form) {
	display: flex;
	align-items: center;
	gap: 0.65rem;
	padding: 0.85rem 1rem;
	border-radius: 18px;
	border: 1px solid var(--color-border, rgba(0, 0, 0, 0.12));
	background: color-mix(in oklab, var(--color-surface, #fff) 94%, transparent);
	box-shadow:
		inset 0 0 0 1px color-mix(in oklab, var(--color-ink, #111) 6%, transparent),
		0 16px 36px color-mix(in oklab, var(--color-ink, #111) 10%, transparent);
}

:global(#search-modal .pagefind-ui__search-input) {
	flex: 1;
	border: none;
	background: transparent;
	font-size: 1rem;
	color: var(--color-ink, currentColor);
	outline: none;
}

:global(#search-modal .pagefind-ui__search-clear) {
	border-radius: 10px;
	padding: 0.35rem 0.5rem;
	border: 1px solid transparent;
	background: color-mix(in oklab, var(--color-ink, #111) 6%, transparent);
	cursor: pointer;
	transition: border-color 120ms ease, background-color 120ms ease;
}

:global(#search-modal .pagefind-ui__search-clear:hover) {
	border-color: var(--color-border, rgba(0, 0, 0, 0.12));
	background: color-mix(in oklab, var(--color-ink, #111) 8%, transparent);
}

:global(#search-modal .pagefind-ui__results) {
	margin-top: 1rem;
	max-height: 60vh;
	overflow-y: auto;
	display: grid;
	gap: 0.6rem;
}

:global(#search-modal .pagefind-ui__result) {
	padding: 0.9rem 1rem;
	border: 1px solid var(--color-border, rgba(0, 0, 0, 0.12));
	border-radius: 14px;
	background: color-mix(in oklab, var(--color-surface, #fff) 92%, transparent);
	transition: border-color 120ms ease, transform 120ms ease;
}

:global(#search-modal .pagefind-ui__result:hover) {
	border-color: color-mix(in oklab, var(--color-ink, #111) 20%, transparent);
	transform: translateY(-1px);
}

:global(#search-modal .pagefind-ui__result-title) {
	margin: 0 0 0.35rem;
	font-size: 1rem;
	font-weight: 700;
}

:global(#search-modal .pagefind-ui__result-excerpt) {
	margin: 0;
	color: var(--color-muted, #6b6b6b);
}

:global(#search-modal .pagefind-ui__message) {
	text-align: left;
	font-size: 0.95rem;
	color: var(--color-muted, #6b6b6b);
}

@media (max-width: 720px) {
	.search-modal__panel {
		margin-top: clamp(16px, 5vh, 42px);
		padding: 1rem;
	}

	.search-modal__header {
		align-items: flex-start;
		flex-direction: column;
	}

	.search-modal__actions {
		align-self: flex-end;
	}

	.search-trigger {
		width: 100%;
		justify-content: center;
	}

	.search-trigger__label {
		font-size: 0.74rem;
	}
}
</style>
