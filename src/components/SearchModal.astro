---
import Search from "astro-pagefind/components/Search";
import { Icon } from 'astro-icon/components';
---

<button
	type="button"
	id="search-toggle"
	aria-haspopup="dialog"
	aria-controls="search-modal"
	aria-expanded="false"
	aria-label="Open search dialog"
	class="header-button"
>
	<span class="sr-only">Open search dialog</span>
	<span class="search-trigger__icon" aria-hidden="true">
		<Icon name="tabler:search" size={18} stroke-width={1} />
	</span>
</button>

<div
	id="search-modal"
	class="search-modal"
	role="dialog"
	aria-modal="true"
	aria-hidden="true"
	aria-labelledby="search-modal-title"
	inert
>
	<div class="search-modal__backdrop" data-close="search"></div>
	<div class="search-modal__panel">
		<div class="search-modal__header">
			<div class="search-modal__title">
				<p class="search-modal__eyebrow">Search</p>
				<h2 id="search-modal-title">Find anything on the site</h2>
			</div>
			<div class="search-modal__actions">
				<span class="search-modal__hint">Esc</span>
				<button type="button" class="search-close" id="search-close" aria-label="Close search dialog">
					<Icon name="tabler:x" size={16} stroke-width={1.6} />
				</button>
			</div>
		</div>
		<div id="search-root" hidden>
			<Search id="search" className="pagefind-ui" uiOptions={{ showImages: false }} />
		</div>
		<p class="search-modal__footnote">Powered by Pagefind. Start typing to search posts, pages, and team members.</p>
	</div>
</div>

<script is:inline>
const searchModal = document.getElementById('search-modal');
const searchToggle = document.getElementById('search-toggle');
const searchClose = document.getElementById('search-close');
const searchBackdrop = document.querySelector('[data-close="search"]');

// Ensure modal is not constrained by ancestor transforms/overflow.
if (searchModal && searchModal.parentElement !== document.body) {
	document.body.appendChild(searchModal);
}

const setSearchVisibility = (isOpen) => {
	if (!searchModal) return;
	searchModal.classList.toggle('is-open', isOpen);
	searchModal.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
	searchModal.toggleAttribute('inert', !isOpen);
	// hide or show the actual Search component so there are no focusable descendants in the DOM while closed
	const searchRoot = document.getElementById('search-root');
	if (searchRoot) searchRoot.hidden = !isOpen;
	if (searchToggle) searchToggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
	document.body.classList.toggle('search-open', isOpen);

	// Ensure focusable descendants are not reachable while the dialog is hidden
	const focusableSelector = 'a, button, input, textarea, select, [tabindex]';
	const nodes = searchModal.querySelectorAll(focusableSelector);
	nodes.forEach((node) => {
		if (isOpen) {
			// restore previous tabindex if it was stored
			if (node.dataset.oldTabindex !== undefined) {
				if (node.dataset.oldTabindex === 'null') node.removeAttribute('tabindex');
				else node.setAttribute('tabindex', node.dataset.oldTabindex);
				delete node.dataset.oldTabindex;
			}
		} else {
			// store current tabindex then set -1 to prevent focus
			node.dataset.oldTabindex = node.hasAttribute('tabindex') ? node.getAttribute('tabindex') : 'null';
			node.setAttribute('tabindex', '-1');
		}
	});
};

// Helper to add missing aria attributes to Pagefind UI when it mounts
const addAriaToPagefind = () => {
	const clearBtn = document.querySelector('#search-modal .pagefind-ui__search-clear');
	if (clearBtn && !clearBtn.hasAttribute('aria-label')) {
		clearBtn.setAttribute('aria-label', 'Clear search');
		clearBtn.setAttribute('title', 'Clear search');
	}
};

// Observe mutations to detect when Pagefind renders its UI and then enhance it
const ensurePagefindEnhancements = () => {
	addAriaToPagefind();
	const mo = new MutationObserver(addAriaToPagefind);
	if (searchModal) mo.observe(searchModal, { childList: true, subtree: true });
};

// Ensure modal is in the closed/hidden state on load and run enhancements
setTimeout(() => setSearchVisibility(false), 0);
ensurePagefindEnhancements();

const focusSearchInput = () => {
	const input = document.querySelector('#search-modal .pagefind-ui__search-input');
	if (input instanceof HTMLInputElement) {
		input.focus();
		input.select();
	}
};

const openSearch = () => {
	setSearchVisibility(true);
	window.requestAnimationFrame(() => {
		window.setTimeout(focusSearchInput, 60);
	});
};

const closeSearch = () => {
	setSearchVisibility(false);
};

if (searchToggle) searchToggle.addEventListener('click', openSearch);
if (searchClose) searchClose.addEventListener('click', closeSearch);
if (searchBackdrop) searchBackdrop.addEventListener('click', closeSearch);

window.addEventListener('keydown', (event) => {
	if (event.key === 'Escape' && searchModal?.classList.contains('is-open')) {
		closeSearch();
	}
});
</script>

<style is:inline>

.search-trigger__icon {
	display: inline-flex;
	align-items: center;
	justify-content: center;
}

.search-modal {
	position: fixed;
	inset: 0;
	width: 100vw;
	height: 100vh;
	z-index: 80;
	display: flex;
	align-items: flex-start;
	justify-content: center;
	padding: clamp(12px, 4vw, 32px);
	opacity: 0;
	pointer-events: none;
	transition: opacity 180ms ease;
}

.search-modal.is-open {
	opacity: 1;
	pointer-events: auto;
}

.search-modal__backdrop {
	position: fixed;
	inset: 0;
	width: 100vw;
	height: 100vh;
	background: var(--color-paper, #f9f9f9);
	backdrop-filter: blur(14px) saturate(1.2);
	opacity: 0.94;
	z-index: 0;
}

:global(html[data-theme='dark'] .search-modal__backdrop) {
	background: color-mix(in oklab, var(--color-paper, #101012) 35%, #06060a 65%);
}

.search-modal__panel {
	position: relative;
	width: min(960px, 100%);
	margin-top: clamp(32px, 6vh, 96px);
	border: 1px solid var(--color-border, rgba(0, 0, 0, 0.12));
	background: color-mix(in oklab, var(--color-surface, #fff) 94%, transparent);
	border-radius: 24px;
	box-shadow: 0 24px 80px color-mix(in oklab, var(--color-ink, #111) 12%, transparent);
	padding: clamp(1rem, 2vw, 1.5rem);
	z-index: 1;
}

.search-modal__header {
	display: flex;
	align-items: center;
	justify-content: space-between;
	gap: 1rem;
	margin-bottom: 0.75rem;
}

.search-modal__title h2 {
	margin: 0.15rem 0 0;
	font-size: clamp(1.2rem, 2vw, 1.45rem);
}

.search-modal__eyebrow {
	margin: 0;
	font-size: 0.7rem;
	letter-spacing: 0.2em;
	text-transform: uppercase;
	color: var(--color-muted, #6b6b6b);
}

.search-modal__actions {
	display: inline-flex;
	align-items: center;
	gap: 0.65rem;
}

.search-modal__hint {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	min-width: 42px;
	padding: 0.35rem 0.5rem;
	border-radius: 10px;
	border: 1px solid color-mix(in oklab, var(--color-ink) 12%, transparent);
	background: color-mix(in oklab, var(--color-ink) 12%, var(--color-surface));
	color: var(--color-ink);
	font-size: 0.72rem;
	letter-spacing: 0.1em;
	text-transform: uppercase;
}

.search-close {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	width: 36px;
	height: 36px;
	border-radius: 12px;
	border: 1px solid var(--color-border, rgba(0, 0, 0, 0.12));
	background: color-mix(in oklab, var(--color-surface, #fff) 90%, transparent);
	color: var(--color-ink, currentColor);
	cursor: pointer;
	transition: border-color 150ms ease, background-color 150ms ease, transform 150ms ease;
}

.search-close:hover {
	border-color: color-mix(in oklab, var(--color-ink, #111) 26%, transparent);
	background: color-mix(in oklab, var(--color-surface, #fff) 82%, var(--color-ink, #111) 6%);
	transform: translateY(-1px);
}

.search-modal__footnote {
	margin: 0.75rem 0 0;
	font-size: 0.82rem;
	color: var(--color-muted, #6b6b6b);
}

:global(body.search-open) {
	overflow: hidden;
}

:global(#search-modal .pagefind-ui) {
	width: 100%;
}

:global(#search-modal .pagefind-ui__form) {
	display: flex;
	align-items: center;
	gap: 0.65rem;
	padding: 0.85rem 1rem;
	border-radius: 18px;
	border: 1px solid var(--color-border, rgba(0, 0, 0, 0.12));
	background: color-mix(in oklab, var(--color-surface, #fff) 94%, transparent);
	box-shadow:
		inset 0 0 0 1px color-mix(in oklab, var(--color-ink, #111) 6%, transparent),
		0 16px 36px color-mix(in oklab, var(--color-ink, #111) 10%, transparent);
}

:global(#search-modal .pagefind-ui__search-input) {
	flex: 1;
	border: none;
	background: transparent;
	font-size: 1rem;
	color: var(--color-ink, currentColor);
	outline: none;
}

:global(#search-modal .pagefind-ui__search-clear) {
	border-radius: 10px;
	padding: 0.35rem 0.5rem;
	border: 1px solid transparent;
	background: color-mix(in oklab, var(--color-ink, #111) 6%, transparent);
	cursor: pointer;
	transition: border-color 120ms ease, background-color 120ms ease;
}

:global(#search-modal .pagefind-ui__search-clear:hover) {
	border-color: var(--color-border, rgba(0, 0, 0, 0.12));
	background: color-mix(in oklab, var(--color-ink, #111) 8%, transparent);
}

:global(#search-modal .pagefind-ui__results) {
	margin-top: 1rem;
	max-height: 60vh;
	overflow-y: auto;
	display: grid;
	gap: 0.6rem;
}

:global(#search-modal .pagefind-ui__result) {
	padding: 0.9rem 1rem;
	border: 1px solid var(--color-border, rgba(0, 0, 0, 0.12));
	border-radius: 14px;
	background: color-mix(in oklab, var(--color-surface, #fff) 92%, transparent);
	transition: border-color 120ms ease, transform 120ms ease;
}

:global(#search-modal .pagefind-ui__result:hover) {
	border-color: color-mix(in oklab, var(--color-ink, #111) 20%, transparent);
	transform: translateY(-1px);
}

:global(#search-modal .pagefind-ui__result-title) {
	margin: 0 0 0.35rem;
	font-size: 1rem;
	font-weight: 700;
}

:global(#search-modal .pagefind-ui__result-excerpt) {
	margin: 0;
	color: var(--color-muted, #6b6b6b);
}

:global(#search-modal .pagefind-ui__message) {
	text-align: left;
	font-size: 0.95rem;
	color: var(--color-muted, #6b6b6b);
}

@media (max-width: 720px) {
	.search-modal__panel {
		margin-top: clamp(16px, 5vh, 42px);
		padding: 1rem;
	}

	.search-modal__header {
		align-items: flex-start;
		flex-direction: column;
	}

	.search-modal__actions {
		align-self: flex-end;
	}


}
</style>
